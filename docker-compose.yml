version: "3.9"
services:
  kicks-sniper-build:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        IMAGE_TAG: ${IMAGE_TAG:-latest}
    image: kicks-sniper:${IMAGE_TAG:-latest}
    # 不啟動任何流程，僅用於 build 鏡像

  kicks-sniper-etl:
    image: kicks-sniper:${IMAGE_TAG:-latest}
    # env_file: - .env  # 已移除，改用 entrypoint 兼容機制
    # 若 .env 不存在也不報錯
    entrypoint: /bin/sh -c "if [ -f .env ]; then export $(grep -v '^#' .env | xargs); fi; exec \"$@\""
    volumes:
      - ./data:/app/data
    command: poetry run python run.py --mode push
    restart: unless-stopped

  kicks-sniper-crawler:
    image: kicks-sniper:${IMAGE_TAG:-latest}
    # env_file: - .env  # 已移除，改用 entrypoint 兼容機制
    entrypoint: /bin/sh -c "if [ -f .env ]; then export $(grep -v '^#' .env | xargs); fi; exec \"$@\""
    volumes:
      - ./data:/app/data
    command: poetry run python run.py --mode crawl
    restart: unless-stopped

  kicks-sniper-all:
    image: kicks-sniper:${IMAGE_TAG:-latest}
    # env_file: - .env  # 已移除，改用 entrypoint 兼容機制
    entrypoint: /bin/sh -c "if [ -f .env ]; then export $(grep -v '^#' .env | xargs); fi; exec \"$@\""
    volumes:
      - ./data:/app/data
    command: poetry run python run.py --mode all  # 一鍵依序執行所有流程
    restart: unless-stopped

# build 指令：docker compose build kicks-sniper-build
# 其他 service 共用 kicks-sniper:${IMAGE_TAG} 鏡像